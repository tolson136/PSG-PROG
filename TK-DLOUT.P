/*******************************************************************/
/* tk-dlout.p                                                      */
/*                                                                 */
/* Outstanding D/L ticket report                                   */
/*                                                                 */
/*  04/16/2018   TO    Added test mode flag                        */
/*  04/17/2018   TO    Changed to simply report                    */
/*                     based on month, general                     */
/*                     cleanup                                     */
/*                     Added option for specific Subs and only     */  
/*                     process route 0 (no route) to eliminate     */
/*                     similar report options/menus                */
/*                                                                 */
/*******************************************************************/

DEFINE SHARED VARIABLE XCOM AS INTEGER FORMAT "ZZ".
DEFINE SHARED VARIABLE XDIV AS INTEGER FORMAT "ZZ".

DEFINE VARIABLE TestMode      AS LOGICAL INIT No.
DEFINE VARIABLE ProcessMonth  AS INTEGER FORMAT "ZZ" LABEL "ENTER MONTH TO REPORT".
DEFINE VARIABLE TotAmtRem     AS DECIMAL FORMAT "$->>>,>>>,>>>.99".
DEFINE VARIABLE SubOption     AS CHAR FORMAT "X" LABEL "(A)ll or Sub#?".
DEFINE VARIABLE SubOptionInt  AS INTEGER.

DISPLAY SPACE(9)
"O U T S T A N D I N G   D/L   T I C K E T   R E P O R T (tk-dlout.p)"
SKIP(2) WITH FRAME C NO-BOX SIDE-LABELS.
UPDATE SKIP(1) ProcessMonth SKIP(2)
       SubOption
   WITH FRAME C NO-BOX SIDE-LABELS.
IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN LEAVE.
IF SubOption NE "A" THEN SubOptionInt = INTEGER(SubOption).

IF NOT TestMode THEN OUTPUT TO PRINTER.
ELSE OUTPUT TO "c:\psg-work\tk-dlout2.txt".

FOR EACH TICKET WHERE TICKET.COMP# = XCOM AND
		      TICKET.DIV# = XDIV AND
		      (T-STAT = "I" OR T-STAT = "Z" OR
		      T-STAT = "P" OR T-STAT = "Y") AND
		      TICKET.MONTH# = ProcessMonth
		         NO-LOCK
				    BY TICKET.CUST#
				    BY TICKET.PROPSL#
				    BY TICKET.ITEM#
				    BY TICKET.MONTH#
				    BY TICKET.T-INDX:
   IF SubOption = "A" AND 
      ( Ticket.Sub# EQ 2 OR
        Ticket.Sub# GE 4) THEN Next.
   IF SubOption NE "A" AND Ticket.Sub# NE SubOptionInt THEN NEXT.
   IF Ticket.Route# NE 0 THEN Next.      				    
   FORM HEADER TODAY FORMAT "99/99/9999"
	 "OUTSTANDING D/L TICKET REPORT" AT 26 SKIP(1)
	 "COMPANY" AT 20 TICKET.COMP# "DIVISION" AT 50 TICKET.DIV# SKIP(1)
	 "Month:" AT 20 ProcessMonth SKIP(1).
	 	 
   FIND FIRST ACCT-RCV WHERE 
     ACCT-RCV.COMP#    = TICKET.COMP# AND
     ACCT-RCV.DIV#     = TICKET.DIV# AND
     ACCT-RCV.CUST#    = TICKET.CUST# AND
     ACCT-RCV.C-STATUS <> "I"
     NO-LOCK NO-ERROR.
   IF NOT AVAILABLE ACCT-RCV THEN NEXT.

   FIND FIRST PROPSL WHERE 
     PROPSL.COMP# = TICKET.COMP# AND
     PROPSL.DIV# = TICKET.DIV# AND
     PROPSL.CUST# = TICKET.CUST# AND
     PROPSL.PROPSL# = TICKET.PROPSL# 
     NO-LOCK NO-ERROR.

   DISPLAY SKIP(0) 
           ACCT-RCV.C-NAME 
           PROPSL.L-NAME 
           TICKET.FREQ 
            SKIP(0) 
           TICKET.CUST# 
           TICKET.PROPSL# 
           TICKET.ITEM# 
           TICKET.MONTH#
	    TICKET.T-INDX SPACE(10) 
	    TICKET.DATE-PRT 
	    TICKET.T-STAT TICKET.TOT-AMT-REM SKIP(0)
	       WITH WIDTH 90.
   ASSIGN TotAmtRem  = TotAmtRem  + TICKET.TOT-AMT-REM.
END.

DISPLAY SKIP(2) 
        SPACE(60) TotAmtRem   SKIP(0)
	   with frame b no-labels.
