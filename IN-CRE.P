/*************************************************/
/* in-cre.p                                      */
/*                                               */
/* Generate orders from completed job orders     */
/*                                               */
/*            */
/*                                               */
/*                                               */
/*************************************************/ 

DEFINE SHARED VARIABLE XCOM AS INTEGER FORMAT "ZZ".
DEFINE SHARED VARIABLE XDIV AS INTEGER FORMAT "ZZ".
DEFINE SHARED VARIABLE XCOM-N AS CHAR FORMAT "X(30)".
DEFINE SHARED VARIABLE XDIV-N AS CHAR FORMAT "X(30)".
DEF SHARED VAR XOPR AS CHAR FORMAT "XXX".
DEFINE VARIABLE D5 AS INTEGER FORMAT "9999" LABEL "YEAR (4 DIGITS)".
DEFINE VARIABLE BEG# AS INTEGER FORMAT "ZZ"
  LABEL "ENTER MONTH & YEAR FOR WHICH YOU WANT TO CREATE ORD/INV".
DEF VAR PALL AS LOGICAL
  LABEL "PROCESS P-STATUS TICKETS FOR THIS CUSTOMER ?".
DEF VAR IALL AS LOGICAL
  LABEL "PROCESS INCOMPLETE TICKETS FOR THIS CUSTOMER ?".
DEF VAR ZALL AS LOGICAL
  LABEL "PROCESS COMPLETED TICKETS FOR THIS CUSTOMER  ?".
DEF VAR IPAR AS CHAR FORMAT "X"
  LABEL "CHARGE <M>ONTH TODATE OR <W>HOLE AMOUNT ?".
DEF VAR XORD AS DECIMAL FORMAT "ZZZZZZZZZZ".
DEF VAR XITM AS INTEGER FORMAT "ZZZZ".
DEF WORKFILE WKX
    FIELD WKXCUST AS DECIMAL FORMAT "ZZZZZZZZZZ"
    FIELD WKXCODE AS CHAR FORMAT "X"
    FIELD WKXPROP AS DECIMAL FORMAT "ZZZZZZZZZZ".
IF (USERID = "OPERATIONS") OR (USERID = "LANDMARK") OR (USERID = "GARCIA")
THEN DO:
    MESSAGE "YOU ARE NOT AUTHORIZED TO RUN THIS PROCEDURE".
    RETURN.
END.
    UPDATE BEG# D5 SKIP(5) WITH NO-BOX SIDE-LABELS.
   FOR EACH ACCT-RCV /* USE-INDEX INDX1 */
                     WHERE ACCT-RCV.COMP# = XCOM AND
                           ACCT-RCV.DIV# = XDIV AND
                           ACCT-RCV.C-STATUS <> "I"
                           BY ACCT-RCV.CUST#:
                           
   HIDE FRAME A.
   HIDE FRAME C.
   HIDE FRAME I.
   HIDE FRAME P.
   PALL = no.
   IALL = no.
   ZALL = no.
   IPAR = "".
   FIND FIRST TICKET /* USE-INDEX INDX1 */
                    WHERE TICKET.COMP# = ACCT-RCV.COMP# AND
                           TICKET.DIV# = ACCT-RCV.DIV# AND
                           TICKET.CUST# = ACCT-RCV.CUST# AND
                           ticket.route = 0 and
                           MONTH(TICKET.DATE-RET) = BEG# AND
                           (TICKET.T-STAT = "C" OR
                            TICKET.T-STAT = "I") NO-ERROR.
   IF NOT AVAILABLE TICKET THEN NEXT.
   FIND FIRST TICKET /* USE-INDEX INDX1 */
                     WHERE TICKET.COMP# = ACCT-RCV.COMP# AND
                           TICKET.DIV# = ACCT-RCV.DIV# AND
                           TICKET.CUST# = ACCT-RCV.CUST# AND
                           ticket.route# = 0 and
                           MONTH(TICKET.DATE-RET) = BEG# AND
                           TICKET.T-STAT = "C" NO-ERROR.
   IF AVAILABLE TICKET THEN ZALL = yes.
   FIND FIRST TICKET /* USE-INDEX INDX1 */
                    WHERE TICKET.COMP# = ACCT-RCV.COMP# AND
                           TICKET.DIV# = ACCT-RCV.DIV# AND
                           TICKET.CUST# = ACCT-RCV.CUST# AND
                           ticket.route# = 0 and
                           MONTH(TICKET.DATE-RET) = BEG# AND
                           TICKET.T-STAT = "P" NO-ERROR.
   IF AVAILABLE TICKET THEN PALL = yes.
   FIND FIRST TICKET /* USE-INDEX INDX1 */
                     WHERE TICKET.COMP# = ACCT-RCV.COMP# AND
                           TICKET.DIV# = ACCT-RCV.DIV# AND
                           TICKET.CUST# = ACCT-RCV.CUST# AND
                           ticket.route# = 0 and
                           MONTH(TICKET.DATE-RET) = BEG# AND
                           TICKET.T-STAT = "I" NO-ERROR.
   IF AVAILABLE TICKET THEN IALL = yes.
   DISPLAY ACCT-RCV.CUST# LABEL "CUSTOMER NUMBER" SPACE(5)
           ACCT-RCV.C-NAME LABEL "CUSTOMER NAME"
       WITH FRAME A OVERLAY NO-BOX SIDE-LABELS.
   IF ZALL THEN UPDATE ZALL SKIP(1)
       WITH FRAME C OVERLAY NO-BOX SIDE-LABELS.
   IF IALL THEN UPDATE IALL SKIP(1) IPAR SKIP(1)
       WITH FRAME I OVERLAY NO-BOX SIDE-LABELS.
   IF PALL THEN UPDATE PALL
       WITH FRAME P OVERLAY NO-BOX SIDE-LABELS.
   FOR EACH TICKET /* USE-INDEX INDX1 */
                   WHERE TICKET.COMP# = ACCT-RCV.COMP# AND
                         TICKET.DIV# = ACCT-RCV.DIV# AND
                         TICKET.CUST# = ACCT-RCV.CUST# AND
                         ticket.route# = 0 and
                         MONTH(TICKET.DATE-RET) = BEG# AND
                           (TICKET.T-STAT = "C" OR
                            TICKET.T-STAT = "I" OR
                            TICKET.T-STAT = "P" ):
   IF TICKET.T-STAT = "C" AND TICKET.TOT-AMT-REM = 0.00 THEN DO:
       TICKET.T-STAT = "W".
       NEXT.
   END.
   IF TICKET.T-STAT = "C" AND ZALL THEN TICKET.T-STAT = "D".
   IF TICKET.T-STAT = "I" AND IALL AND IPAR = "W" THEN TICKET.T-STAT = "E".
   IF TICKET.T-STAT = "P" AND PALL THEN TICKET.T-STAT = "F".
   IF TICKET.T-STAT = "I" AND IALL AND IPAR = "M" THEN TICKET.T-STAT = "G".
END.
END.
     FOR EACH TICKET /* USE-INDEX INDX1 */
                     WHERE TICKET.COMP# = XCOM AND
                           TICKET.DIV# = XDIV AND
                           ticket.route# = 0 and
                           MONTH(TICKET.DATE-RET) = BEG# AND
                           (TICKET.T-STAT = "D" OR
                            TICKET.T-STAT = "E" OR
                            TICKET.T-STAT = "F" OR
                            TICKET.T-STAT = "G")
                           BREAK BY TICKET.PROPSL#:
   IF FIRST-OF(TICKET.PROPSL#) THEN DO:
       FIND FIRST SYSCONTROL EXCLUSIVE-LOCK.
       XORD = SYSCONTROL.NEXT-ORD + 1.
       SYSCONTROL.NEXT-ORD = XORD.
       RELEASE SYSCONTROL.
       XITM = 0.
   END.
   FIND FIRST PROPSL /* USE-INDEX INDX */
               WHERE PROPSL.COMP# = TICKET.COMP# AND
                     PROPSL.DIV# = TICKET.DIV# AND
                     PROPSL.CUST# = TICKET.CUST# AND
                     PROPSL.PROPSL# = TICKET.PROPSL# NO-ERROR.
   IF NOT AVAILABLE PROPSL THEN UNDO, NEXT.
   FIND FIRST PRO-DESP /* USE-INDEX INDX2 */
                 WHERE PRO-DESP.COMP# = TICKET.COMP# AND
                       PRO-DESP.DIV# = TICKET.DIV# AND
                       PRO-DESP.CUST# = TICKET.CUST# AND
                       pro-desp.route# = 0 and
                       PRO-DESP.PROPSL# = TICKET.PROPSL# AND
                       PRO-DESP.ITEM# = TICKET.ITEM# NO-ERROR.
   IF NOT AVAILABLE PRO-DESP THEN DO:
       HIDE MESSAGE.
       MESSAGE "Pro-Descr not avail" skip "Cust# " TICKET.CUST# "Propsl# " TICKET.PROPSL# "Item# " TICKET.ITEM# "Route 0"  VIEW-AS ALERT-BOX.
       UNDO, NEXT.
   END.
   FIND FIRST ACCT-RCV /* USE-INDEX INDX1 */
                 WHERE ACCT-RCV.COMP# = TICKET.COMP# AND
                       ACCT-RCV.DIV# = TICKET.DIV# AND
                       ACCT-RCV.CUST# = TICKET.CUST#.
   CREATE INVOICE.
   UPDATE INVOICE.COMP# = TICKET.COMP#.
   UPDATE INVOICE.DIV# = TICKET.DIV#.
   UPDATE INVOICE.CUST# = TICKET.CUST#.
   UPDATE INVOICE.PROPSL# = TICKET.PROPSL#.
   UPDATE INVOICE.L-NAME = PROPSL.L-NAME.
   UPDATE INVOICE.C-DATE = TICKET.DATE-RET.
   UPDATE INVOICE.PRICE = TICKET.DL - TICKET.DL-LAST.
   UPDATE INVOICE.ORD-NO = XORD.
   IF TICKET.T-STAT = "D" OR TICKET.T-STAT = "E" OR  TICKET.T-STAT = "F"
       THEN UPDATE INVOICE.TOT-INV = TICKET.TOT-AMT-REM.
   IF TICKET.T-STAT = "G" THEN
       UPDATE INVOICE.TOT-INV = TICKET.MTD-VOL.
   UPDATE INVOICE.ITEM# = TICKET.ITEM#.
   UPDATE INVOICE.MONTH# = MONTH(TICKET.DATE-RET).
   UPDATE INVOICE.T-INDX = TICKET.T-INDX.
   XITM = XITM + 1.
   UPDATE INVOICE.ITM-NO = XITM.
   UPDATE INVOICE.SLS# = TICKET.M-NUM.
   UPDATE INVOICE.INV-OPR = XOPR.
   UPDATE INVOICE.PO# = PRO-DESP.PO#.
   UPDATE INVOICE.SUB# = PRO-DESP.SUB#.
   UPDATE INVOICE.ROUTE# = PRO-DESP.ROUTE#.
   UPDATE INVOICE.APPR-CD = "A".
   UPDATE INVOICE.LNE-STAT = "A".
   UPDATE INVOICE.I-TYPE = "N".
   UPDATE INVOICE.REC-TYPE = "T".
   UPDATE INVOICE.I-DESRP = "TRANSFERRED FROM COMPLETED JOBS".
   UPDATE INVOICE.TERM-CD = ACCT-RCV.TERM-CD.
   UPDATE INVOICE.LADDR01 = PROPSL.LADDR01.
   UPDATE INVOICE.LADDR02 = PROPSL.LADDR02.
   UPDATE INVOICE.LADDR03 = PROPSL.LADDR03.
   FIND FIRST TERMFILE NO-ERROR.
   IF  AVAILABLE TERMFILE THEN DO:
       IF ACCT-RCV.TERM-CD = "1" THEN UPDATE INVOICE.TERM-DSC = TERM01.
       ELSE IF ACCT-RCV.TERM-CD = "2" THEN UPDATE INVOICE.TERM-DSC = TERM02.
       ELSE IF ACCT-RCV.TERM-CD = "3" THEN UPDATE INVOICE.TERM-DSC = TERM03.
       ELSE IF ACCT-RCV.TERM-CD = "4" THEN UPDATE INVOICE.TERM-DSC = TERM04.
       ELSE IF ACCT-RCV.TERM-CD = "5" THEN UPDATE INVOICE.TERM-DSC = TERM05.
       ELSE IF ACCT-RCV.TERM-CD = "6" THEN UPDATE INVOICE.TERM-DSC = TERM06.
       ELSE IF ACCT-RCV.TERM-CD = "7" THEN UPDATE INVOICE.TERM-DSC = TERM07.
       ELSE IF ACCT-RCV.TERM-CD = "8" THEN UPDATE INVOICE.TERM-DSC = TERM08.
       ELSE IF ACCT-RCV.TERM-CD = "9" THEN UPDATE INVOICE.TERM-DSC = TERM09.
       ELSE IF ACCT-RCV.TERM-CD = "10" THEN UPDATE INVOICE.TERM-DSC = TERM10.
   END.
        IF TICKET.T-STAT = "D"
            THEN DO:
                TICKET.T-STAT = "W".
                TICKET.WTD-VOL = TICKET.TOT-AMT.
                TICKET.TOT-AMT-REM = 0.0.
            END.
        IF TICKET.T-STAT = "E" OR  TICKET.T-STAT = "F"
            THEN DO:
                TICKET.T-STAT = "Y".
                TICKET.WTD-VOL = TICKET.TOT-AMT.
                TICKET.TOT-AMT-REM = 0.00.
            END.
        IF TICKET.T-STAT = "G"
            THEN DO:
                TICKET.T-STAT = "Z".
                TICKET.TOT-AMT-REM = TICKET.TOT-AMT-REM - TICKET.MTD-VOL.
        END.
   RELEASE INVOICE.
END.
