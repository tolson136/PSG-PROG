DEFINE SHARED VARIABLE XCOM AS INTEGER FORMAT "ZZ".
DEFINE SHARED VARIABLE XDIV AS INTEGER FORMAT "ZZ".
DEFINE SHARED VARIABLE XCOM-N AS CHAR FORMAT "X(30)".
DEFINE SHARED VARIABLE XDIV-N AS CHAR FORMAT "X(30)".
DEFINE SHARED VARIABLE XOPR AS CHAR FORMAT "XXX".
DEFINE VARIABLE XCUST AS DECIMAL FORMAT "ZZZZZZZZZZ".
DEFINE VAR XPROP AS DECIMAL FORMAT "ZZZZZZZZZZ".
DEF VAR XORD AS DECIMAL FORMAT "ZZZZZZZZZZ".
DEF VAR XITEM AS INTEGER FORMAT "ZZZZ".
DEF VAR ANS AS CHAR FORMAT "X" LABEL
 "DO YOU WISH TO <A>DD TO CURRENT OR <C>REATE NEW ORDER ?".
IF (USERID = "OPERATIONS") OR (USERID = "LANDMARK") OR (USERID = "GARCIA")
THEN DO:
    MESSAGE "YOU ARE NOT AUTHORIZED TO RUN THIS PROCEDURE".
    RETURN.
END.
PAR1: REPEAT:
DISPLAY SPACE(24)
"I N V O I C E   S C R E E N         (ADD)"
SKIP(1)
    XCOM-N LABEL "CMP" SPACE(1)
    XDIV-N LABEL "DIV" SPACE(1)
    XOPR LABEL "OPR" SKIP(1) WITH FRAME X.
 UPDATE ANS SKIP(1) WITH FRAME X COLOR DISPLAY NORMAL PROMPT W/MA.
 IF ANS = "C" THEN DO:
   FIND FIRST SYSCONTROL EXCLUSIVE-LOCK.
   XORD = SYSCONTROL.NEXT-ORD + 1.
   SYSCONTROL.NEXT-ORD = XORD.
   RELEASE SYSCONTROL.
   CREATE INVOICE.
   UPDATE INVOICE.ORD-NO = XORD.
   UPDATE INVOICE.COMP# = XCOM.
   UPDATE INVOICE.DIV# = XDIV.
   UPDATE INVOICE.INV-OPR = XOPR.
   UPDATE INVOICE.I-TYPE = "N".
   UPDATE INVOICE.APPR-CD = "A".
   UPDATE INVOICE.LNE-STAT = "A".
   UPDATE INVOICE.I-DATE = TODAY.
   UPDATE INVOICE.MONTH# = MONTH(TODAY).
   UPDATE INVOICE.ITM-NO = 1.
   UPDATE INVOICE.CUST# WITH FRAME X COLOR DISPLAY NORMAL PROMPT W/MA.
   END.
 ELSE IF ANS = "A" THEN DO:
   PROMPT-FOR INVOICE.CUST# SPACE(23) INVOICE.ORD-NO
       WITH FRAME X COLOR DISPLAY NORMAL PROMPT W/MA.
   XORD = INPUT INVOICE.ORD-NO.
   XCUST = INPUT INVOICE.CUST#.
   FIND LAST INVOICE WHERE INVOICE.COMP# = XCOM AND
                           INVOICE.DIV# = XDIV AND
                           INVOICE.CUST# = XCUST AND
                           invoice.route# = 0 and
                           INVOICE.ORD-NO = XORD NO-ERROR.
   IF NOT AVAILABLE INVOICE THEN DO:
       BELL.
       HIDE MESSAGE.
       MESSAGE COLOR BLINK "ORDER #" XORD " NOT CREATED FOR CUST #" XCUST.
       BELL.
       UNDO, RETRY.
   END.
   XITEM = INVOICE.ITM-NO + 1.
   CREATE INVOICE.
   UPDATE INVOICE.ORD-NO = XORD.
   UPDATE INVOICE.COMP# = XCOM.
   UPDATE INVOICE.DIV# = XDIV.
   UPDATE INVOICE.INV-OPR = XOPR.
   UPDATE INVOICE.I-TYPE = "N".
   UPDATE INVOICE.APPR-CD = "A".
   UPDATE INVOICE.LNE-STAT = "A".
   UPDATE INVOICE.I-DATE = TODAY.
   UPDATE INVOICE.MONTH# = MONTH(TODAY).
   UPDATE INVOICE.CUST# = XCUST.
   UPDATE INVOICE.ITM-NO = XITEM.
   update invoice.route# = 0.
   END.
   ELSE DO:
       BELL.
       HIDE MESSAGE.
       MESSAGE COLOR BLINK "THIS ORDER DOES NOT EXIST".
       BELL.
       UNDO, RETRY.
   END.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETURN.
 REPEAT:
 FIND ACCT-RCV WHERE ACCT-RCV.COMP# = XCOM AND ACCT-RCV.DIV# = XDIV AND
                     ACCT-RCV.CUST# = INVOICE.CUST# AND
                     ACCT-RCV.C-STATUS <> "I" NO-ERROR.
 IF NOT AVAILABLE ACCT-RCV THEN DO:
     BELL.
     HIDE MESSAGE.
     MESSAGE COLOR BLINK "THIS CUSTOMER DOES NOT EXIST OR IS INACTIVE".
     BELL.
     UNDO, RETRY.
 END.
 ELSE LEAVE.
 END.
 DISPLAY
         INVOICE.CUST# LABEL "CUST #" SPACE(37)
         INVOICE.ORD-NO LABEL "ORD #" SKIP(0)
         ACCT-RCV.C-NAME LABEL "CUST NAME" SPACE(5)
         INVOICE.ITM-NO LABEL "ORD ITM" SKIP(0) SPACE(41)
         WITH FRAME X NO-BOX SIDE-LABELS.
 UPDATE INVOICE.I-DATE INVOICE.MONTH# WITH FRAME X.
 DISPLAY INVOICE.I-DATE LABEL "ORD DATE"
         INVOICE.MONTH# LABEL "SRVC MONTH" SKIP(0)
         WITH FRAME X NO-BOX SIDE-LABELS.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
REPEAT:
 UPDATE INVOICE.REC-TYPE WITH FRAME X.
 IF INVOICE.REC-TYPE = "R" THEN DO:
     UPDATE INVOICE.I-DESRP = "REGULAR SINGLE ORDER CREATED".
     DISPLAY INVOICE.REC-TYPE LABEL "ORD TYPE" SPACE(4)
     INVOICE.I-DESRP LABEL "DESC" SKIP(0)
     WITH FRAME X NO-BOX SIDE-LABELS.
     LEAVE.
 END.
 ELSE
     IF INVOICE.REC-TYPE = "P" THEN DO:
         UPDATE INVOICE.I-DESRP = "PRE-PAID SINGLE INVOICE CREATED".
         DISPLAY INVOICE.REC-TYPE LABEL "ORD TYPE" SPACE(4)
         INVOICE.I-DESRP LABEL "DESC" SKIP(0)
         WITH FRAME X NO-BOX SIDE-LABELS.
         LEAVE.
     END.
     ELSE DO:
         HIDE MESSAGE.
         BELL.
         MESSAGE COLOR BLINK "INVALID ORDER TYPE".
     END.
END.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
REPEAT:
 UPDATE INVOICE.PROPSL# WITH FRAME X.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
 FIND PROPSL WHERE PROPSL.COMP# = XCOM AND PROPSL.DIV# = XDIV AND
                   PROPSL.CUST# = INVOICE.CUST# AND
                   PROPSL.PROPSL# = INVOICE.PROPSL# NO-ERROR.
 IF NOT AVAILABLE PROPSL THEN DO:
     BELL.
     HIDE MESSAGE.
     MESSAGE COLOR BLINK "THIS PROPOSAL DOES NOT EXIST".
     BELL.
     UNDO, RETRY.
 END.
 ELSE LEAVE.
 END.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
 IF INVOICE.REC-TYPE = "R" THEN DO:
 REPEAT:
     UPDATE INVOICE.ITEM# WITH FRAME X.
     IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, LEAVE.
     FIND PRO-DESP WHERE PRO-DESP.COMP# = XCOM AND
                         PRO-DESP.DIV# = XDIV AND
                         PRO-DESP.CUST# = INVOICE.CUST# AND
                         PRO-DESP.PROPSL# = INVOICE.PROPSL# AND
                         PRO-DESP.ITEM# = INVOICE.ITEM# NO-ERROR.
     IF NOT AVAILABLE PRO-DESP THEN DO:
         HIDE MESSAGE.
         BELL.
         MESSAGE COLOR BLINK
             "THIS ITEM # DOES NOT EXIST FOR PROPOSAL " INVOICE.PROPSL#.
     END.
     ELSE LEAVE.
 END.
 END.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
 DISPLAY INVOICE.PROPSL# LABEL "PRO #" SPACE(2)
         INVOICE.ITEM# LABEL "ITM #" SPACE(4) WITH FRAME X NO-BOX SIDE-LABELS.
 IF INVOICE.REC-TYPE <> "P" THEN
         DISPLAY PRO-DESP.FREQ LABEL "FREQ" SKIP(0)
         WITH FRAME X NO-BOX SIDE-LABELS.
 DISPLAY
         PROPSL.L-NAME LABEL "LOCATION NAME" SKIP(0)
         WITH FRAME X NO-BOX SIDE-LABELS.
 REPEAT:
 UPDATE INVOICE.SLS# WITH FRAME X.
 FIND SALESMAN WHERE SALESMAN.SLS# = INVOICE.SLS# NO-ERROR.
 IF NOT AVAILABLE SALESMAN THEN DO:
     BELL.
     HIDE MESSAGE.
     MESSAGE COLOR BLINK "THIS MANAGER DOES NOT EXIST".
     BELL.
     UNDO, RETRY.
 END.
 ELSE LEAVE.
 END.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
 DISPLAY INVOICE.SLS# LABEL "MANAGER #" SPACE(3)
         SALESMAN.SLSNAME LABEL "MANAGER'S NAME" SKIP(0)
         WITH FRAME X NO-BOX SIDE-LABELS.
 UPDATE INVOICE.TERM-CD WITH FRAME X.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
   FIND FIRST TERMFILE NO-ERROR.
   IF NOT AVAILABLE TERMFILE THEN DO:
       HIDE MESSAGE.
       MESSAGE "TERM FILE HAS NOT BEEN CREATED".
   END.
   ELSE DO:
       IF INVOICE.TERM-CD = "1" THEN UPDATE INVOICE.TERM-DSC = TERM01.
       ELSE IF INVOICE.TERM-CD = "2" THEN UPDATE INVOICE.TERM-DSC = TERM02.
       ELSE IF INVOICE.TERM-CD = "3" THEN UPDATE INVOICE.TERM-DSC = TERM03.
       ELSE IF INVOICE.TERM-CD = "4" THEN UPDATE INVOICE.TERM-DSC = TERM04.
       ELSE IF INVOICE.TERM-CD = "5" THEN UPDATE INVOICE.TERM-DSC = TERM05.
       ELSE IF INVOICE.TERM-CD = "6" THEN UPDATE INVOICE.TERM-DSC = TERM06.
       ELSE IF INVOICE.TERM-CD = "7" THEN UPDATE INVOICE.TERM-DSC = TERM07.
       ELSE IF INVOICE.TERM-CD = "8" THEN UPDATE INVOICE.TERM-DSC = TERM08.
       ELSE IF INVOICE.TERM-CD = "9" THEN UPDATE INVOICE.TERM-DSC = TERM09.
       ELSE IF INVOICE.TERM-CD = "10" THEN UPDATE INVOICE.TERM-DSC = TERM10.
   END.
 DISPLAY INVOICE.TERM-CD LABEL "TERM CODE" SPACE(5)
         INVOICE.TERM-DSC LABEL "TERM DESC" SKIP(0)
         INVOICE.PO# LABEL "PURCHASE ORDER NUMBER" SKIP(0)
         INVOICE.C-DATE LABEL "COMPLETION DATE" SPACE(5)
         INVOICE.PRICE LABEL "DIRECT LABOR AMOUNT" SKIP(0)
         INVOICE.TOT-INV LABEL "INVOICE AMOUNT"
         WITH FRAME X NO-BOX SIDE-LABELS.
 UPDATE INVOICE.PO# INVOICE.C-DATE INVOICE.PRICE INVOICE.TOT-INV WITH FRAME X.
   RELEASE INVOICE.
    IF LASTKEY = KEYCODE("F4") OR LASTKEY = KEYCODE("ESC") THEN UNDO, RETRY.
  END.
